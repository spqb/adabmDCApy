name: Test adabmDCA

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: â¬‡ï¸ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: ğŸ“‚ Create test output directory
      run: mkdir -p test_outputs

    # Train bmDCA model (quick test with target=0.2)
    - name: ğŸ§¬ Train bmDCA model
      run: |
        adabmDCA train \
          --data example_data/RF00379.fasta \
          --output test_outputs/ \
          --model bmDCA \
          --alphabet rna \
          --target 0.1 \
          --nsweeps 1 \
          --nchains 100 \
          --label bmDCA_test \
          --seed 42
    
    # Test contacts prediction using bmDCA parameters
    - name: ğŸ”— Predict contacts (from bmDCA parameters)
      run: |
        adabmDCA contacts \
          --path_params test_outputs/bmDCA_test_params.dat \
          --output test_outputs/ \
          --alphabet rna
    
    # Test contacts prediction using data file (mean-field)
    - name: ğŸ”— Predict contacts (mean-field from data)
      run: |
        adabmDCA contacts \
          --data example_data/RF00379.fasta \
          --output test_outputs/ \
          --alphabet rna
    
    # Test sampling from bmDCA model
    - name: ğŸ² Sample from bmDCA model
      run: |
        adabmDCA sample \
          --path_params test_outputs/bmDCA_test_params.dat \
          --output test_outputs/ \
          --ngen 100 \
          --data example_data/RF00379.fasta \
          --max_nsweeps 2 \
          --alphabet rna \
          --label sampling_test
    
    # Test energy computation
    - name: âš¡ Compute energies
      run: |
        adabmDCA energies \
          --data example_data/RF00379.fasta \
          --path_params test_outputs/bmDCA_test_params.dat \
          --output test_outputs/ \
          --alphabet rna \
    
    # Test DMS (Deep Mutational Scanning)
    - name: ğŸ§ª Deep Mutational Scanning
      run: |
        adabmDCA DMS \
          --data example_data/RF00379.fasta \
          --path_params test_outputs/bmDCA_test_params.dat \
          --output test_outputs/ \
          --alphabet rna \
          --label dms_test
    
    # Test thermodynamic integration (entropy computation)
    - name: ğŸŒ¡ï¸ Thermodynamic Integration (entropy)
      run: |
        adabmDCA entropy \
          --data example_data/RF00379.fasta \
          --path_targetseq example_data/RF00379.fasta \
          --path_params test_outputs/bmDCA_test_params.dat \
          --output test_outputs/ \
          --alphabet rna \
          --nchains 100 \
          --nsteps 2 \
          --label entropy_test
    
    # Train eaDCA model
    - name: ğŸ§¬ Train eaDCA model
      run: |
        adabmDCA train \
          --data example_data/RF00379.fasta \
          --output test_outputs/ \
          --model eaDCA \
          --alphabet rna \
          --target 0.1 \
          --nsweeps 1 \
          --nchains 100 \
          --label eaDCA_test \
          --seed 42
    
    # Train edDCA model using bmDCA as starting point
    - name: ğŸ§¬ Train edDCA model (with bmDCA initialization)
      run: |
        adabmDCA train \
          --data example_data/RF00379.fasta \
          --output test_outputs/ \
          --model edDCA \
          --alphabet rna \
          --target 0.1 \
          --nsweeps 1 \
          --density 0.95 \
          --path_params test_outputs/bmDCA_test_params.dat \
          --path_chains test_outputs/bmDCA_test_chains.fasta \
          --label edDCA_test \
          --seed 42
    
    # Verify output files were created
    - name: âœ… Verify output files
      run: |
        echo "Checking bmDCA outputs..."
        test -f test_outputs/bmDCA_test_params.dat || (echo "Missing bmDCA params" && exit 1)
        test -f test_outputs/bmDCA_test_chains.fasta || (echo "Missing bmDCA chains" && exit 1)
        test -f test_outputs/bmDCA_test.log || (echo "Missing bmDCA log" && exit 1)
        
        echo "Checking eaDCA outputs..."
        test -f test_outputs/eaDCA_test_params.dat || (echo "Missing eaDCA params" && exit 1)
        test -f test_outputs/eaDCA_test_chains.fasta || (echo "Missing eaDCA chains" && exit 1)
        test -f test_outputs/eaDCA_test.log || (echo "Missing eaDCA log" && exit 1)
        
        echo "Checking edDCA outputs..."
        test -f test_outputs/edDCA_test_params.dat || (echo "Missing edDCA params" && exit 1)
        test -f test_outputs/edDCA_test_chains.fasta || (echo "Missing edDCA chains" && exit 1)
        test -f test_outputs/edDCA_test.log || (echo "Missing edDCA log" && exit 1)
        
        echo "Checking script outputs..."
        test -f test_outputs/sampling_test_chains.fasta || (echo "Missing sampling chains" && exit 1)
        test -f test_outputs/energies_test_energies.fasta || (echo "Missing energies output" && exit 1)
        test -f test_outputs/dms_test_DMS.fasta || (echo "Missing DMS output" && exit 1)
        
        echo "All required output files exist! âœ…"
    
    # Upload test artifacts
    - name: ğŸ“¤ Upload test outputs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-outputs
        path: test_outputs/
        retention-days: 7
